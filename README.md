# WorkTypes API

A RESTful API built with Rust for managing worktypes. This project implements a simple CRUD API with an additional duplication feature.

## Technologies

- **Rust**: Programming language
- **Tokio**: Asynchronous runtime
- **Axum**: HTTP framework
- **Serde**: JSON serialization/deserialization
- **UUID**: For generating unique identifiers
- **Chrono**: For date and time handling
- **SQLx**: For PostgreSQL database interaction

## Project Structure

```text
worktypes-api/
├── Cargo.lock                                # Automatically generated by Cargo to lock exact dependency versions
├── Cargo.toml                                # Project configuration file (dependencies, metadata, etc.)
├── deploy-docker                             # Likely contains scripts or resources for Docker deployment
├── docker                                     # Docker and Supabase setup/config files
├── migrations
│   └── 20231201000000_create_table.sql       # Initial database migration (creates tables, etc.)
├── README.md                                 # Main documentation for the project
├── src
│   ├── config.rs                             # Global configuration (e.g., database, environment)
│   ├── error.rs                              # Custom error definitions (e.g., AppError)
│   ├── lib.rs                                # Library entry point (used if the project is a crate)
│   ├── main.rs                               # Main executable entry point
│   ├── modules                               # Domain-specific logic modules
│   │   ├── companies                         # Domain module for company-related logic
│   │   │   ├── handlers.rs                   # HTTP handlers (controllers) for company endpoints
│   │   │   ├── models.rs                     # Struct definitions for company entities
│   │   │   ├── mod.rs                        # Re-exports company submodules (memory, postgres, routes, etc.)
│   │   │   ├── repositories                  # Company repository implementations
│   │   │   │   ├── memory.rs                 # In-memory repository (for testing/mocking)
│   │   │   │   ├── mod.rs                    # Declares and exposes the company repository modules
│   │   │   │   ├── postgres.rs               # PostgreSQL-based company repository
│   │   │   │   └── repository.rs             # Repository trait (interface) for companies
│   │   │   └── routes.rs                     # Route definitions for company-related HTTP endpoints
│   │   ├── mod.rs                            # Declares and re-exports all domain modules
│   │   └── worktypes                         # Domain module for work type logic
│   │       ├── handlers.rs                   # HTTP handlers for worktypes
│   │       ├── models.rs                     # Struct definitions for worktype entities
│   │       ├── mod.rs                        # Main worktypes module
│   │       ├── repository.rs                 # Trait and implementation for the worktype repository
│   │       └── requests.rs                   # Structs representing incoming HTTP requests for this module
│   ├── repositories
│   │   ├── mod.rs                            # Declares the shared repository module
│   │   └── postgres.rs                       # Shared PostgreSQL repository logic (e.g., DB pool, helpers)
│   └── server.rs                             # HTTP server setup and startup (e.g., Axum, Actix)
└── tests
    └── api_tests.rs                          # Integration tests for the API (endpoints, responses, etc.)
```

## API Endpoints

| Method | Endpoint                  | Description                         |
|--------|---------------------------|-------------------------------------|
| GET    | /companies                | List all companies (filter by name) |
| POST   | /companies                | Create a new company                |
| GET    | /companies/{id}           | Get a company by ID                 |
| PUT    | /companies/{id}           | Update a company                    |
| POST   | /companies/{id}/duplicate | Duplicate a company                 |
| GET    | /worktypes                | List all worktypes (filter by name) |
| POST   | /worktypes                | Create a new company                |
| GET    | /worktypes/{id}           | Get a company by ID                 |
| PUT    | /worktypes/{id}           | Update a company                    |
| POST   | /worktypes/{id}/duplicate | Duplicate a company                 |

## Installation and Running Locally

### Prerequisites

- Rust and Cargo (install from [https://rustup.rs/](https://rustup.rs/))
- PostgreSQL (optional, falls back to in-memory storage if not available), or;
- Supabase + PostgreSQL (optional, there is a already prepared script for its deployment in [deploy-docker](./deploy-docker))

### Steps

1. Clone the repository:

   ```bash
   git clone https://github.com/yourusername/worktypes-api.git
   cd worktypes-api
   ```

2. Set up the database (optional):

   ```bash
   # Set the DATABASE_URL environment variable
   export DATABASE_URL=postgres://username:password@localhost/db

   # Create the database
   createdb companies_db

   # Run migrations (if using sqlx-cli)
   sqlx migrate run

3. Build the project:

   ```bash
   cargo build --release
   ```

4. Run the server:

   ```bash
   cargo run --release
   ```

The API will be available at `http://localhost:3000`.

> [!NOTE]
>
> If you are going to run the script [deploy-docker](./deploy-docker) for the deployment of
> the Supabase Docker container that includes a PostgreSQL database,
> make sure to add the following configuration to the `.env` file located at the root of your project.

```text
DATABASE_URL=postgres://postgres.local-tenant:postgres@localhost:5432/postgres
PORT=3000
```

## Deployment

This is if you want to deploy the api by using rust. Remember to get already the postgres database ready. There is a supabase deployment script [deploy-docker](./deploy-docker)

### Docker Deployment

1. Create a Dockerfile in the project root:

   ```dockerfile
   FROM rust:1.70 as builder
   WORKDIR /usr/src/app
   COPY . .
   RUN cargo build --release

   FROM debian:bullseye-slim
   RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*
   COPY --from=builder /usr/src/app/target/release/companies-api /usr/local/bin/
   EXPOSE 3000
   CMD ["companies-api"]
   ```

2. Build the Docker image:

   ```bash
   docker build -t companies-api .
   ```

3. Run the container:

   ```bash
   docker run -p 3000:3000 -e DATABASE_URL=postgres://username:password@host.docker.internal/companies_db companies-api
   ```

## Adding New Modules

The project is structured to easily add new modules:

1. Create a new directory under `src/modules/` for your module
2. Implement the module following the same pattern as the companies module
3. Register the module in `src/modules/mod.rs`
4. Add the module's routes to the server in `src/server.rs`

## Usage Examples

### List Companies

```bash
curl http://localhost:3000/companies
```

### Filter Companies by Name

```bash
curl http://localhost:3000/companies?name=tech
```

### Create a Company

```bash
curl -X POST http://localhost:3000/companies \
  -H "Content-Type: application/json" \
  -d '{"name": "Acme Inc."}'
```

### Get a Company by ID

```bash
curl http://localhost:3000/companies/YOUR_COMPANY_ID
```

### Update a Company

```bash
curl -X PUT http://localhost:3000/companies/YOUR_COMPANY_ID \
  -H "Content-Type: application/json" \
  -d '{"name": "Acme Corporation"}'
```

### Duplicate a Company

```bash
curl -X POST http://localhost:3000/companies/YOUR_COMPANY_ID/duplicate
```

## License

MIT
