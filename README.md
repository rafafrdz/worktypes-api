# WorkTypes API

A RESTful API built in Rust for managing work types and companies. This project implements basic CRUD operations along with a duplication feature.

## Technologies

- **Rust**: Systems programming language used to build the API
- **Tokio**: Asynchronous runtime
- **Axum**: HTTP web framework
- **Serde**: JSON serialization/deserialization
- **UUID**: For generating unique identifiers
- **Chrono**: For handling date and time
- **SQLx**: Async PostgreSQL driver and query builder

## Project Structure

```text
worktypes-api/
├── Cargo.lock                                # Auto-generated by Cargo to lock dependency versions
├── Cargo.toml                                # Project config file (dependencies, metadata, etc.)
├── deploy-docker                             # Scripts/resources for Docker deployment
├── docker                                     # Supabase and Docker config files
├── migrations
│   └── 20231201000000_create_table.sql       # Initial DB schema
├── README.md                                 # Project documentation
├── src
│   ├── config.rs                             # Global configuration (e.g., DB, environment)
│   ├── error.rs                              # Custom error types (e.g., AppError)
│   ├── lib.rs                                # Library entry point if used as a crate
│   ├── main.rs                               # Application entry point
│   ├── modules                               # Business/domain logic
│   │   ├── companies                         # Company-related logic
│   │   │   ├── handlers.rs                   # HTTP controllers for company routes
│   │   │   ├── models.rs                     # Structs for company entities
│   │   │   ├── mod.rs                        # Re-exports company submodules
│   │   │   ├── repositories
│   │   │   │   ├── memory.rs                 # In-memory repository (for testing)
│   │   │   │   ├── mod.rs                    # Declares repository submodules
│   │   │   │   ├── postgres.rs               # PostgreSQL-based company repository
│   │   │   │   └── repository.rs             # Company repository trait/interface
│   │   │   └── routes.rs                     # Route definitions
│   │   ├── mod.rs                            # Declares all modules
│   │   └── worktypes                         # Work type logic
│   │       ├── handlers.rs                   # HTTP handlers for work types
│   │       ├── models.rs                     # Structs for work type entities
│   │       ├── mod.rs                        # Worktypes module root
│   │       ├── repository.rs                 # Trait and implementation for worktypes
│   │       └── requests.rs                   # Request structs for HTTP endpoints
│   ├── repositories
│   │   ├── mod.rs                            # General/shared repositories module
│   │   └── postgres.rs                       # Shared PostgreSQL logic (e.g., DB pool)
│   └── server.rs                             # Server setup (Axum, Actix, etc.)
└── tests
    └── api_tests.rs                          # API integration tests
```

## API Endpoints

| Method | Endpoint                  | Description                           |
|--------|---------------------------|---------------------------------------|
| GET    | /companies                | List all companies (with name filter) |
| POST   | /companies                | Create a new company                  |
| GET    | /companies/{id}           | Get a company by ID                   |
| PUT    | /companies/{id}           | Update a company                      |
| POST   | /companies/{id}/duplicate | Duplicate a company                   |
| GET    | /worktypes                | List all worktypes (with name filter) |
| POST   | /worktypes                | Create a new worktype                 |
| GET    | /worktypes/{id}           | Get a worktype by ID                  |
| PUT    | /worktypes/{id}           | Update a worktype                     |
| POST   | /worktypes/{id}/duplicate | Duplicate a worktype                  |

## Installation and Local Development

### Prerequisites

- Rust and Cargo ([https://rustup.rs/](https://rustup.rs/))
- PostgreSQL (optional, falls back to in-memory if not available)
- Supabase + PostgreSQL (optional; ready-to-use setup in [deploy-docker](./deploy-docker))

### Steps

1. Clone the repository:

   ```bash
   git clone https://github.com/yourusername/worktypes-api.git
   cd worktypes-api
   ```

2. Set up the database (optional):

   ```bash
   # Set the DATABASE_URL environment variable
   export DATABASE_URL=postgres://username:password@localhost/db

   # Create the database
   createdb companies_db

   # Run migrations (if using sqlx-cli)
   sqlx migrate run
   ```

3. Build the project:

   ```bash
   cargo build --release
   ```

4. Run the server:

   ```bash
   cargo run --release
   ```

The API will be available at \`http://localhost:3000\`.

> **Note:**
> If you're using the [deploy-docker](./deploy-docker) script to run Supabase + PostgreSQL in Docker,
> add the following configuration to a `.env` file at the project root:

```text
DATABASE_URL=postgres://postgres.local-tenant:postgres@localhost:5432/postgres
PORT=3000
```

## Deployment

If you'd like to deploy the API using Rust, ensure that a PostgreSQL instance is already available.
You can also use the Supabase deployment script in [deploy-docker](./deploy-docker).

### Docker Deployment

1. Create a Dockerfile in the project root:

   ```dockerfile
   FROM rust:1.70 as builder
   WORKDIR /usr/src/app
   COPY . .
   RUN cargo build --release

   FROM debian:bullseye-slim
   RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*
   COPY --from=builder /usr/src/app/target/release/worktypes-api /usr/local/bin/
   EXPOSE 3000
   CMD ["worktypes-api"]
   ```

2. Build the Docker image:

   ```bash
   docker build -t worktypes-api .
   ```

3. Run the container:

   ```bash
   docker run -p 3000:3000 -e DATABASE_URL=postgres://username:password@host.docker.internal/companies_db worktypes-api
   ```

## Adding New Modules

To add a new module:

1. Create a new directory under \`src/modules/\`
2. Follow the same structure used in the `companies` module
3. Register your module in \`src/modules/mod.rs\`
4. Add your routes in \`src/server.rs\`

## Usage Examples

### List Companies

```bash
curl http://localhost:3000/companies
```

### Filter Companies by Name

```bash
curl http://localhost:3000/companies?name=tech
```

### Create a Company

```bash
curl -X POST http://localhost:3000/companies \
  -H "Content-Type: application/json" \
  -d '{"name": "Acme Inc."}'
```

### Get a Company by ID

```bash
curl http://localhost:3000/companies/YOUR_COMPANY_ID
```

### Update a Company

```bash
curl -X PUT http://localhost:3000/companies/YOUR_COMPANY_ID \
  -H "Content-Type: application/json" \
  -d '{"name": "Acme Corporation"}'
```

### Duplicate a Company

```bash
curl -X POST http://localhost:3000/companies/YOUR_COMPANY_ID/duplicate
```

## License

MIT
